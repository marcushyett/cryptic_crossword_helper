<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{TITLE}}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(15, 30px);
            grid-template-rows: repeat(15, 30px);
            gap: 1px;
            border: 2px solid #000;
            background: #000;
            width: fit-content;
        }
        .cell {
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            position: relative;
            cursor: pointer;
            width: 30px;
            height: 30px;
        }
        .cell.blank {
            background: black;
        }
        .cell .number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #666;
        }
        .clues {
            flex: 1;
            min-width: 0;
        }
        .clue-group {
            margin-bottom: 20px;
        }
        .clue {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
            word-wrap: break-word;
        }
        .clue:hover {
            background: #f0f0f0;
        }
        .clue.revealed {
            background: #e0ffe0;
        }
        .reveal-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin-left: 10px;
            margin-top: 5px;
            display: inline-block;
        }
        .reveal-btn:hover {
            background: #0056b3;
        }
        .reveal-word-btn {
            background: #dc3545;
        }
        .reveal-word-btn:hover {
            background: #c82333;
        }
        .check-btn {
            background: #28a745;
        }
        .check-btn:hover {
            background: #218838;
        }
        .answer {
            display: none;
            font-weight: bold;
            color: #007bff;
        }
        .clue.revealed .answer {
            display: inline;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                flex-direction: column;
                gap: 10px;
            }
            .grid {
                grid-template-columns: repeat(15, 24px);
                grid-template-rows: repeat(15, 24px);
                margin: 0 auto;
            }
            .cell {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }
            .cell .number {
                font-size: 8px;
                top: 1px;
                left: 1px;
            }
            .clues {
                width: 100%;
            }
            .clue {
                padding: 8px;
                font-size: 14px;
            }
            .reveal-btn {
                padding: 4px 8px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .grid {
                grid-template-columns: repeat(15, 20px);
                grid-template-rows: repeat(15, 20px);
            }
            .cell {
                width: 20px;
                height: 20px;
                font-size: 12px;
            }
            .cell .number {
                font-size: 7px;
            }
            h1 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <h1>{{TITLE}}</h1>
    <div style="margin-bottom: 10px;">
        <button id="clearGridBtn" style="background: #6c757d; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px;">Clear Grid</button>
    </div>
    <div class="container">
        <div class="grid" id="grid"></div>
        <div class="clues" id="clues"></div>
    </div>

    <script>
        const gameData = {{GAME_DATA}};

        let gridState = {};
        let revealedClues = new Set();
        let revealedLetters = {}; // Track revealed letters per word
        let storageKey = '';

        function init() {
            // Create unique storage key based on puzzle title
            storageKey = 'crossword_' + gameData.title.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
            
            loadState(); // Load saved state first
            createGrid();
            createClues();
            
            // Add clear grid button functionality
            document.getElementById('clearGridBtn').addEventListener('click', clearGrid);
        }

        function createGrid() {
            const gridEl = document.getElementById('grid');
            gameData.grid.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    const cellEl = document.createElement('div');
                    cellEl.className = 'cell';
                    if (cell.Blank === 'blank') {
                        cellEl.classList.add('blank');
                    } else {
                        cellEl.textContent = gridState[`${rowIndex}-${colIndex}`] || '';
                        cellEl.contentEditable = true;
                        cellEl.addEventListener('input', (e) => {
                            const value = e.target.textContent.toUpperCase();
                            e.target.textContent = value.slice(-1); // Only last character
                            gridState[`${rowIndex}-${colIndex}`] = value.slice(-1);
                            saveState();
                        });
                        if (cell.Number) {
                            const numEl = document.createElement('div');
                            numEl.className = 'number';
                            numEl.textContent = cell.Number;
                            cellEl.appendChild(numEl);
                        }
                    }
                    gridEl.appendChild(cellEl);
                });
            });
        }

        function createClues() {
            const cluesEl = document.getElementById('clues');
            const groups = {};
            
            gameData.clues.forEach(clue => {
                if (!groups[clue.direction]) {
                    groups[clue.direction] = [];
                }
                groups[clue.direction].push(clue);
            });

            Object.keys(groups).forEach(direction => {
                const groupEl = document.createElement('div');
                groupEl.className = 'clue-group';
                groupEl.innerHTML = `<h3>${direction.charAt(0).toUpperCase() + direction.slice(1)}</h3>`;
                
                groups[direction].forEach(clue => {
                    const clueEl = document.createElement('div');
                    clueEl.className = 'clue';
                    clueEl.dataset.wordId = clue.word_id;
                    
                    const revealBtn = document.createElement('button');
                    revealBtn.className = 'reveal-btn';
                    revealBtn.textContent = 'Reveal Letter';
                    revealBtn.addEventListener('click', () => revealLetter(clue));
                    
                    const revealWordBtn = document.createElement('button');
                    revealWordBtn.className = 'reveal-btn reveal-word-btn';
                    revealWordBtn.textContent = 'Reveal Word';
                    revealWordBtn.addEventListener('click', () => revealAnswer(clue));
                    
                    const checkBtn = document.createElement('button');
                    checkBtn.className = 'reveal-btn check-btn';
                    checkBtn.textContent = 'Check Solution';
                    checkBtn.addEventListener('click', () => checkSolution(clue));
                    
                    clueEl.innerHTML = `
                        <strong>${clue.number}.</strong> ${clue.clue} (${clue.length})
                        <span class="answer"> (${clue.answer})</span>
                    `;
                    clueEl.appendChild(revealBtn);
                    clueEl.appendChild(checkBtn);
                    clueEl.appendChild(revealWordBtn);
                    
                    if (revealedClues.has(clue.word_id)) {
                        clueEl.classList.add('revealed');
                        fillGridWithAnswer(clue);
                    } else if (revealedLetters[clue.word_id]) {
                        // Fill in revealed letters for this word
                        const positions = getWordPositions(clue.word_id);
                        revealedLetters[clue.word_id].forEach(index => {
                            const [row, col] = positions[index];
                            const cellEl = document.querySelector(`.grid .cell:nth-child(${row * 15 + col + 1})`);
                            if (cellEl && !cellEl.classList.contains('blank')) {
                                cellEl.textContent = clue.answer[index];
                                gridState[`${row}-${col}`] = clue.answer[index];
                            }
                        });
                    }
                    
                    groupEl.appendChild(clueEl);
                });
                
                cluesEl.appendChild(groupEl);
            });
        }

        function checkSolution(clue) {
            const wordId = clue.word_id;
            const positions = getWordPositions(wordId);
            let correctCount = 0;
            let totalCount = positions.length;
            
            // Check each position
            positions.forEach((pos, index) => {
                const [row, col] = pos;
                const currentLetter = gridState[`${row}-${col}`] || '';
                const correctLetter = clue.answer[index];
                
                if (currentLetter.toUpperCase() === correctLetter.toUpperCase()) {
                    correctCount++;
                }
            });
            
            const percentage = Math.round((correctCount / totalCount) * 100);
            const isCorrect = correctCount === totalCount;
            
            // Show result
            const result = isCorrect 
                ? `✅ Correct! (100% correct)`
                : `❌ Incorrect. ${percentage}% correct (${correctCount}/${totalCount} letters)`;
            
            alert(result);
        }

        function revealLetter(clue) {
            const wordId = clue.word_id;
            
            // Initialize revealed letters for this word if not exists
            if (!revealedLetters[wordId]) {
                revealedLetters[wordId] = new Set();
            }
            
            const positions = getWordPositions(wordId);
            const availablePositions = [];
            
            // Find positions that are either empty or have incorrect letters
            positions.forEach((pos, index) => {
                const [row, col] = pos;
                const currentLetter = gridState[`${row}-${col}`] || '';
                const correctLetter = clue.answer[index];
                
                if (currentLetter !== correctLetter) {
                    availablePositions.push({ pos, index, correctLetter });
                }
            });
            
            if (availablePositions.length === 0) {
                // All letters are correct, mark as fully revealed
                revealedClues.add(wordId);
                const clueEl = document.querySelector(`[data-word-id="${wordId}"]`);
                clueEl.classList.add('revealed');
                saveState();
                return;
            }
            
            // Randomly select one of the available positions
            const randomIndex = Math.floor(Math.random() * availablePositions.length);
            const selected = availablePositions[randomIndex];
            
            // Fill the selected position with the correct letter
            const [row, col] = selected.pos;
            const cellEl = document.querySelector(`.grid .cell:nth-child(${row * 15 + col + 1})`);
            if (cellEl && !cellEl.classList.contains('blank')) {
                cellEl.textContent = selected.correctLetter;
                gridState[`${row}-${col}`] = selected.correctLetter;
                revealedLetters[wordId].add(selected.index);
            }
            
            saveState();
        }

        function fillGridWithAnswer(clue) {
            const word = gameData.grid.flat().find(cell => 
                cell.WordAcrossID == clue.word_id || cell.WordDownID == clue.word_id
            );
            if (!word) return;
            
            const positions = getWordPositions(clue.word_id);
            positions.forEach((pos, index) => {
                const [row, col] = pos;
                const cellEl = document.querySelector(`.grid .cell:nth-child(${row * 15 + col + 1})`);
                if (cellEl && !cellEl.classList.contains('blank')) {
                    cellEl.textContent = clue.answer[index];
                    gridState[`${row}-${col}`] = clue.answer[index];
                }
            });
        }

        function revealAnswer(clue) {
            const wordId = clue.word_id;
            revealedClues.add(wordId);
            const clueEl = document.querySelector(`[data-word-id="${wordId}"]`);
            clueEl.classList.add('revealed');
            fillGridWithAnswer(clue);
            saveState();
        }

        function getWordPositions(wordId) {
            const word = gameData.grid.flat().filter(cell => 
                cell.WordAcrossID == wordId || cell.WordDownID == wordId
            );
            return word.map(cell => {
                const row = Math.floor((cell.SquareID - 1) / 15);
                const col = (cell.SquareID - 1) % 15;
                return [row, col];
            });
        }

        function saveState() {
            localStorage.setItem(storageKey, JSON.stringify({
                grid: gridState,
                revealed: Array.from(revealedClues),
                revealedLetters: Object.fromEntries(
                    Object.entries(revealedLetters).map(([key, set]) => [key, Array.from(set)])
                )
            }));
        }

        function loadState() {
            const state = localStorage.getItem(storageKey);
            if (state) {
                const parsed = JSON.parse(state);
                gridState = parsed.grid || {};
                revealedClues = new Set(parsed.revealed || []);
                revealedLetters = {};
                if (parsed.revealedLetters) {
                    Object.entries(parsed.revealedLetters).forEach(([key, arr]) => {
                        revealedLetters[key] = new Set(arr);
                    });
                }
                
                // Update cells with loaded state
                Object.entries(gridState).forEach(([key, letter]) => {
                    const [row, col] = key.split('-').map(Number);
                    const cellEl = document.querySelector(`.grid .cell:nth-child(${row * 15 + col + 1})`);
                    if (cellEl) {
                        cellEl.textContent = letter;
                    }
                });
            }
        }

        function clearGrid() {
            if (confirm('Are you sure you want to clear the entire grid? This will remove all your progress.')) {
                gridState = {};
                revealedClues = new Set();
                revealedLetters = {};
                
                // Clear all cells
                document.querySelectorAll('.grid .cell').forEach(cell => {
                    if (!cell.classList.contains('blank')) {
                        cell.textContent = '';
                    }
                });
                
                // Reset clue styles
                document.querySelectorAll('.clue').forEach(clue => {
                    clue.classList.remove('revealed');
                });
                
                // Clear local storage
                localStorage.removeItem(storageKey);
            }
        }

        init();
    </script>
</body>
</html>
